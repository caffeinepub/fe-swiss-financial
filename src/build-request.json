{
  "kind": "build_request",
  "title": "Revert Export PDF to popup-window print flow (no jsPDF)",
  "projectName": "FE Swiss CRM",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-49",
      "text": "Rework `frontend/src/utils/pdfDownload.ts` so `downloadPDF(htmlContent, filename)` no longer uses jsPDF/html2canvas (including any dynamic CDN loading), and instead exports via a simple popup-window print flow: (1) `window.open` a new blank popup window, (2) write the full `htmlContent` into the popup via `popupWindow.document.write(htmlContent)`, (3) set `popupWindow.document.title` to the provided `filename` (example: \"Hans_Mueller_FES-2024-0001_2026-02-18\"), (4) call `popupWindow.print()`, and (5) close the popup after printing.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "In pdfDownload.ts, the downloadPDF function should: 1) Use window.open to open a new blank popup window. 2) Write the full HTML content into the popup window using popupWindow.document.write(htmlContent). 3) Set popupWindow.document.title to the desired filename like \"Hans_Mueller_FES-2024-0001_2026-02-18\". 4) Call popupWindow.print(). 5) Close the popup after printing."
        ]
      },
      "acceptanceCriteria": [
        "`downloadPDF()` does not load or reference jsPDF or html2canvas and does not use Blob/objectURL download logic.",
        "Calling `downloadPDF(htmlContent, filename)` opens a new window and writes `htmlContent` into it via `document.write`.",
        "The popup window’s `document.title` is set exactly to the passed `filename` string before calling `print()`.",
        "`popupWindow.print()` is invoked and the popup window is closed after the print dialog completes (use an `afterprint`-based mechanism and a safe fallback if needed).",
        "If the popup cannot be opened (e.g., blocked), `downloadPDF()` fails gracefully with a clear English message (console error is acceptable; a simple user-facing alert is also acceptable)."
      ]
    },
    {
      "id": "REQ-50",
      "text": "Update `frontend/src/pages/ClientDetailPage.tsx` so the Export PDF action builds a filename string from the client’s `firstName`, `lastName`, `accountId`, and today’s date, and passes that filename string to `downloadPDF(pdfHtml, filename)`. Keep `generateClientPDF(client, mockDetailData)` unchanged and keep all other pages unchanged.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "The generateClientPDF function that builds the HTML content should remain unchanged. In ClientDetailPage.tsx, pass the filename string (built from client firstName, lastName, accountId and today's date) to downloadPDF. Keep all other pages unchanged."
        ]
      },
      "acceptanceCriteria": [
        "`ClientDetailPage.tsx` continues to generate HTML via `generateClientPDF(client, mockDetailData)` without modifying `generateClientPDF`.",
        "Export PDF calls `downloadPDF(pdfHtml, filename)` where `filename` is derived from `firstName`, `lastName`, `accountId`, and today’s date (using existing filename-sanitization/date helpers where applicable).",
        "No other routes/pages/components are modified as part of this change."
      ]
    }
  ],
  "constraints": [
    "Do not modify `frontend/src/utils/clientPdfExport.ts` (`generateClientPDF`) output or behavior.",
    "Keep all other pages and features unchanged outside of `frontend/src/utils/pdfDownload.ts` and `frontend/src/pages/ClientDetailPage.tsx`.",
    "User-facing text introduced or changed by this work must be in English.",
    "Do not edit files under `frontend/src/components/ui` or any frontend immutable paths per SYSTEM_CONTEXT."
  ],
  "nonGoals": [
    "Implementing a jsPDF-based or iframe-based PDF export flow.",
    "Changing the PDF HTML layout/content generated by `generateClientPDF`.",
    "Adding new pages, routes, or backend changes."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}